<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>深度学习开发环境配置记录 (tf&#43;torch)</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">深度学习开发环境配置记录 (tf+torch)</span></h1>

<h2 class="date">2018/07/27</h2>
</div>

<main>


<h3 id="versions">Versions</h3>

<ul>
<li>CPU: Intel i5-6300HQ (2.30GHz)</li>

<li><p>GPU: NVIDIA GeForce GTX 950M</p></li>

<li><p>Windows 10 Education</p></li>

<li><p>Ubuntu 16.04 LTS (VirtualBox 5.2.16)</p></li>

<li><p>Python</p>

<ul>
<li>Python 3.6.5 (Windows, Anaconda)</li>
<li>Python 3.5.2 (Ubuntu)</li>
</ul></li>

<li><p>Libraries</p>

<ul>
<li>numpy 1.15.0</li>
<li>pandas 0.23.3</li>
<li>tensorflow 1.9.0</li>
<li>torch 0.4.0</li>
<li>requests 2.9.1</li>
<li>beautifulsoup4 4.4.1</li>
</ul></li>

<li><p>CUDA Toolkit 9.0</p></li>

<li><p>cuDNN 7.0.5 (Dec 5, 2017), for CUDA 9.0</p></li>
</ul>

<h3 id="details">Details</h3>

<p>我的 ubuntu 一直都是配好的，不再赘述。为了便利，我选择使用 Anaconda，安装很容易，只需一路 Next 就行。numpy、pandas、requests 与 bs4 的安装也都很简单，<code>sudo pip3 install</code> 就能直接装上。由于 VBox 不能很好地利用我的显卡，我仅在 Windows 上安装了 GPU 版 Tensorflow，Ubuntu 上只安装了 CPU 版。</p>

<p><a href="https://www.tensorflow.org/install/install_windows#installing_with_native_pip">安装 Tensorflow-GPU</a> 时遇到了一个问题：<code>Distributed 1.21.8 requires msgpack, which is not installed</code>，谷歌搜到<a href="https://stackoverflow.com/questions/51050257/distributed-1-21-8-requires-msgpack-which-is-not-installed">这篇文章</a>，照做即可。不过在真正能够启动 Tensorflow-GPU 前需要安装好 CUDA Toolkit 跟 cuDNN。</p>

<p><a href="https://www.tensorflow.org/install/install_windows">Tensorflow 的引导页</a> 所要求的 CUDA Toolkit 版本为 9.0，然而英伟达官网已经发布了 9.2，为了避免兼容问题，我从<a href="https://developer.nvidia.com/cuda-toolkit-archive">这里</a>找到了 v9.0，下载并安装之即可，<code>%PATH%</code> 它会自动设置好，但是没加全，还得自己加一条 <code>Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9.0\extras\CUPTI\libx64</code>。</p>

<p>cuDNN 也有版本要求。同样，有一个 <a href="https://developer.nvidia.com/rdp/cudnn-archive">Archive 页</a>可供下载，选择符合要求的最新版本 v7.0.5 (Dec 5, 2017), for CUDA 9.0，下载后解压，把 <code>cuDNN/bin/</code> 加到 <code>%PATH%</code> 里（下载需要先注册、登陆），重启 Python 即可。</p>

<p>装上 Tensorflow 后，我把官方提供的例子给克隆了下来，运行时发现数据总是导入失败（失败于 pd.read_csv）。奇怪的是，在 pandas 项目的 issue 页明明能搜到相关的问题，也早就被标记了“Solved”，可是我更新到最新版本（0.23.3）后还是没有解决。这个问题是因为默认路径有包含有中文（也就是我的系统用户名），最后我只能照着<a href="https://blog.csdn.net/qq_33530388/article/details/71739845">这篇文章</a>，把我的系统用户名从中文改为英文。改完重启后，终于顺利跑完 <code>premade_estimator.py</code>。</p>

<p>改完用户名后其实有另外一个问题：VBox 找不到我的虚拟机文件了。要解决这个问题，只要在 <code>~/.VirtualBox</code> 里编辑 <code>VirtualBox.xml</code> 和 <code>VirtualBox.xml-prev</code>，把相应路径改为新的就行了。</p>

<p>但是，折腾完一跑代码我才发现，跑示例代码的时候，CPU 比 GPU 快多了…打扰了…我也不知道为什么。要用 CPU 跑的话，可以加上 <code>with tf.device('/cpu:0')</code>，但我觉得很麻烦，还得修改代码。其实只需要在跑脚本前敲一行 <code>set CUDA_VISIBLE_DEVICES=-1</code> 设置一下环境变量就行了，或者在脚本开头加上：</p>

<pre><code class="language-python">import os
os.environ['CUDA_VISIBLE_DEVICES'] = '-1'
</code></pre>

<p>Pytorch 的安装则直接两行命令搞定：</p>

<pre><code class="language-bash">conda install pytorch cuda90 -c pytorch
pip install torchvision
</code></pre>

<p>包比较大（接近 600M），建议科学上网。装完后我试着跑了一下官方给的 <a href="https://github.com/pytorch/examples/blob/master/mnist/main.py">MNIST 示例代码</a>，发现跑不起来，在 49 行报了错。随即去看了这个文件的 <a href="https://github.com/pytorch/examples/blame/master/mnist/main.py#L49">Blame 页</a>，发现就在我写这篇报告的十二小时前刚有一个<a href="https://github.com/pytorch/examples/commit/75e7c75469d21cb76ada070058889124b850a632">新的 commit</a>，改回去就可以了。这段代码跑起来能明显感到 GPU 对训练速度的提升，估计效率比 CPU 高了两倍以上。</p>

</main>


<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
  
  
  if (window.location.hostname == "localhost")
    return;

  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  var disqus_shortname = 'oyiadin';
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  <footer>
  <script src="/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>



  
  <hr/>
  &copy; <a href="https://blog.b1n.top/">oyiadin</a> | <a href="https://github.com/oyiadin">Github</a> | <a href="https://twitter.com/oyiadin">Twitter</a>
  
  </footer>
  </body>
</html>

