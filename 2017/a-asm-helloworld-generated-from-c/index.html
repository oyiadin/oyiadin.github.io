<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HelloWorld：从 C 到 ASM 之旅 · oyiadin</title><meta name="description" content="HelloWorld：从 C 到 ASM 之旅 - Chen Xiaoyuan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://oyiadin.github.io/atom.xml" title="oyiadin"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/oyiadin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HelloWorld：从 C 到 ASM 之旅</h1><div class="post-info">2017年12月12日</div><div class="post-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* filename: helloworld.c */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hello</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Received: %d\n"</span>, b);</span><br><span class="line">    <span class="keyword">return</span> b+<span class="number">333</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a=<span class="number">111</span>, b=<span class="number">222</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Passing arguments: %d, %d\n"</span>, a, b);</span><br><span class="line">    ++a;</span><br><span class="line">    <span class="keyword">int</span> c = hello(b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">444</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">/* gcc -S helloworld.c -o helloworld.asm */</span><br><span class="line">/* filename: helloworld.asm */</span><br><span class="line"></span><br><span class="line">    .file   &quot;helloworld.c&quot;</span><br><span class="line">    .section .rdata,&quot;dr&quot;</span><br><span class="line"></span><br><span class="line">LC0:</span><br><span class="line">    .ascii &quot;Received: %d\12\0&quot;</span><br><span class="line">    .text</span><br><span class="line">    .globl  _hello</span><br><span class="line">    .def    _hello; .scl    2;  .type   32; .endef</span><br><span class="line">_hello:                             hello 函数开始的地址</span><br><span class="line">LFB10:</span><br><span class="line">    .cfi_startproc                  cfi stands for call frame information</span><br><span class="line">                                    for debugging purpose [1] [2]</span><br><span class="line">    pushl   %ebp                    保护 main() 的栈基</span><br><span class="line">    .cfi_def_cfa_offset 8</span><br><span class="line">    .cfi_offset 5, -8</span><br><span class="line">    movl    %esp, %ebp              重设栈基，新空栈 [3]</span><br><span class="line">                                    进入(stdcall, [4])函数后首先需要的步骤</span><br><span class="line">    .cfi_def_cfa_register 5</span><br><span class="line">    subl    $24, %esp               我也不清楚为什么要拓展这么大的空间</span><br><span class="line">    movl    8(%ebp), %eax           8(%ebp) 就是传过来的 b</span><br><span class="line">                                    准备调用 printf()</span><br><span class="line">    movl    %eax, 4(%esp)           先把第二个参数入栈</span><br><span class="line">    movl    $LC0, (%esp)            再把第一个参数入栈，LC0 正好就是对应数据</span><br><span class="line">    call    _printf                 正式调用 printf()</span><br><span class="line">    movl    8(%ebp), %eax           准备好当前函数的 b（从内存中挪到寄存器）</span><br><span class="line">    addl    $333, %eax              b += 555</span><br><span class="line">                                    不用挪回内存，因为本函数已经不需要用到 b 了</span><br><span class="line">    leave</span><br><span class="line">    .cfi_restore 5</span><br><span class="line">    .cfi_def_cfa 4, 4</span><br><span class="line">    ret                             回到 main 函数</span><br><span class="line">                                    %eax 是约定好的放置函数返回值的地方 [4]</span><br><span class="line">    .cfi_endproc</span><br><span class="line"></span><br><span class="line">LFE10:</span><br><span class="line">    .def    ___main;    .scl    2;  .type   32; .endef</span><br><span class="line">    .section .rdata,&quot;dr&quot;</span><br><span class="line">LC1:</span><br><span class="line">    .ascii &quot;Passing arguments: %d, %d\12\0&quot;</span><br><span class="line">    .text</span><br><span class="line">    .globl  _main</span><br><span class="line">    .def    _main;  .scl    2;  .type   32; .endef</span><br><span class="line">_main:</span><br><span class="line">LFB11:</span><br><span class="line">    .cfi_startproc</span><br><span class="line">    pushl   %ebp                    保护栈基</span><br><span class="line">    .cfi_def_cfa_offset 8</span><br><span class="line">    .cfi_offset 5, -8</span><br><span class="line">    movl    %esp, %ebp              重设栈基，新空栈</span><br><span class="line">    .cfi_def_cfa_register 5</span><br><span class="line">    andl    $-16, %esp</span><br><span class="line">    subl    $32, %esp</span><br><span class="line">    call    ___main                 我也不清楚这个 __main 是什么</span><br><span class="line">    movl    $111, 28(%esp)          局部变量存在于栈中 [5]</span><br><span class="line">    movl    $222, 24(%esp)</span><br><span class="line">    movl    24(%esp), %eax          参数开始入栈，从右到左 [4]</span><br><span class="line">    movl    %eax, 8(%esp)</span><br><span class="line">    movl    28(%esp), %eax</span><br><span class="line">    movl    %eax, 4(%esp)</span><br><span class="line">    movl    $LC1, (%esp)</span><br><span class="line">    call    _printf                 正式调用 printf()</span><br><span class="line">    addl    $1, 28(%esp)            ++a</span><br><span class="line">    movl    24(%esp), %eax</span><br><span class="line">    movl    %eax, (%esp)            这两行使参数 b 入栈</span><br><span class="line">    call    _hello                  调用 hello</span><br><span class="line">                                    gcc 自动给函数名前缀一个 _ 符号</span><br><span class="line">                                    这在 c++ 中有不同的规则</span><br><span class="line">                                    所以有些代码需要 extern &quot;C&quot;</span><br><span class="line">    movl    %eax, 20(%esp)          hello() 的返回值置于 %eax，入栈成为局部变量 c</span><br><span class="line">    movl    $444, %eax              同样，%eax 放置函数返回值，main 也不例外</span><br><span class="line">    leave</span><br><span class="line">    .cfi_restore 5</span><br><span class="line">    .cfi_def_cfa 4, 4</span><br><span class="line">    ret</span><br><span class="line">    .cfi_endproc</span><br><span class="line">LFE11:</span><br><span class="line">    .ident  &quot;GCC: (GNU) 5.3.0&quot;</span><br><span class="line">    .def    _printf;    .scl    2;  .type   32; .endef</span><br></pre></td></tr></table></figure>
<hr>
<p>Reference:</p>
<p><a href="https://stackoverflow.com/a/33732119" target="_blank" rel="noopener">1: In assembly code how .cfi directives work - An answer by @ysdx, Stackoverflow</a><br><a href="http://sourceware.org/binutils/docs-2.18/as/CFI-directives.html" target="_blank" rel="noopener">2: .cfi directives</a><br><a href="https://en.wikipedia.org/wiki/Call_stack#Structure" target="_blank" rel="noopener">3: Call stack #Structure, wikipedia</a><br><a href="https://zh.wikipedia.org/wiki/X86%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A#stdcall" target="_blank" rel="noopener">4: X86 调用约定 #stdcall, wikipedia</a><br><a href="https://www.jianshu.com/p/b2380e47d005" target="_blank" rel="noopener">5: C语言-内存管理基础, 简书</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/2-dimension-array-in-c/" class="prev">上一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'oyiadin';
var disqus_identifier = '2017/a-asm-helloworld-generated-from-c/';
var disqus_title = 'HelloWorld：从 C 到 ASM 之旅';
var disqus_url = 'http://oyiadin.github.io/2017/a-asm-helloworld-generated-from-c/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//oyiadin.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2018 <a href="http://oyiadin.github.io">Chen Xiaoyuan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>